# JSN-SR04T

Light and portable driver for ultrasonic module JSN-SR04T with high level API, written in C.

# Introduction

The JSN-SR04T is a cheap module for distance measurement by ultrasonic sound.

![JSN-SR04T module](/img/module_img.jpg "The JSN-SR04T module hardware.")

The module is apparently compatible with a HC-SR04, but this has not been tested, as I do not have one.

# Requirements

The module requires:
* 5V power supply,
* 3.3V Digital output (trigger) 
* 3.3V Digital input (echo)
* GND

This driver requires:
* Timer with 10us periods
* External interrupts on the echo pin on rising and falling edges.
* Functions for reading from and writting to a GPIO pins.

# How to use the driver

* Clone the repository 
* Copy the jsn-sr04 hrader and C file to your project.
* Include the header file.
* Peripherals configuration:
** 1 GPIO as output.
** 1 GPIO pin as input with interrupt being generated on rising and falling edge.
** Timer with period 10us
* Call the JSN_10us_timer_callback from the timer ISR.
* Call the JSN_GPIO_EXTI_callback from the GPIO ISR.
* Define JSN_GPIO_Get_value_wrapper and JSN_GPIO_Set_value_wrapper in your application to call your GPIO Read/Write functions.
* Initiate the module by calling JSN_Init
* Use the rest of the API to measure the distance.

## Example
This example illustrates the usage of the driver with one module in an application using the low level code generated by STM CubeMX utility on STM32f103 MCU.

This example is not compilable as is. It is here just for illustration what has to be done to measure distance.

	#include "stm32f1xx_hal.h"
	#include "jsn-sr04t.h"

	TIM_HandleTypeDef htim2;
	UART_HandleTypeDef huart1;
	jsn_sr04t_desc_t usonic_sensor;

	unsigned int JSN_GPIO_Get_value_wrapper(void* GPIO_Port, void* GPIO_Pin) {
		return HAL_GPIO_ReadPin((GPIO_TypeDef*)GPIO_Port, (uint16_t*)GPIO_Pin);
	}

	void JSN_GPIO_Set_value_wrapper(void* GPIO_Port, void* GPIO_Pin, unsigned int value) {
		HAL_GPIO_WritePin((GPIO_TypeDef*)GPIO_Port, (uint16_t*)GPIO_Pin, value);
	}

	void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim) {
		JSN_10us_timer_callback(&usonic_sensor);
	}


	void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin) {
		if (GPIO_Pin == US_echo_Pin) {
			JSN_GPIO_EXTI_callback(&usonic_sensor);
		}
	}

	int main(void) {
		HAL_Init();

		/* Configure the system clock */
		SystemClock_Config();

		/* Initialize all configured peripherals */
		MX_GPIO_Init();
		MX_TIM2_Init();
		HAL_TIM_Base_Start_IT(&htim2);
		MX_USART1_UART_Init();

		jsn_sr04t_ret_val_t ret_val;
		jsn_sr04t_state_t state;

		while (1) {
			if ((ret_val = JSN_Measure(&usonic_sensor)) != JSN_SUCCESS) {
				text_len = snprintf(&buffer, 127, "Starting measuring failed: %d.\r\n", ret_val);
				HAL_UART_Transmit(&huart1, buffer, text_len, 1000);
			}

			while(1) {
				state = JSN_GetState(&usonic_sensor);
				if (state == JSN_FINISHED) {
					text_len = snprintf(&buffer, 127, "Distance: %d cm.\r\n", JSN_GetDistance_cm(&usonic_sensor));
					HAL_UART_Transmit(&huart1, buffer, text_len, 1000);
					break;
				}
				else if (state == JSN_FAILURE) {
					text_len = snprintf(&buffer, 127, "Measuring failed.\r\n");
					HAL_UART_Transmit(&huart1, buffer, text_len, 1000);
					break;
				}
			}
			Delay_ms(100);
	}
